import os
import time
import numpy as np
import pandas as pd
import yfinance as yf
import matplotlib
import matplotlib.pyplot as plt
from matplotlib.font_manager import FontProperties
from flask import Flask, request, abort, send_from_directory

from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage, ImageSendMessage

# --- è¨­å®š matplotlib å¾Œç«¯ (ç„¡ä»‹é¢æ¨¡å¼) ---
matplotlib.use('Agg')

app = Flask(__name__)

# --- 1. è¨­å®šå¯†é‘° (Render ç’°å¢ƒè®Šæ•¸å„ªå…ˆï¼Œæ‰¾ä¸åˆ°å‰‡ä½¿ç”¨é è¨­å€¼) ---
# å»ºè­°ï¼šç‚ºäº†å®‰å…¨ï¼Œä¹‹å¾Œè«‹åœ¨ Render å¾Œå°è¨­å®šé€™äº›è®Šæ•¸ï¼Œä¸è¦å°‡çœŸå¯¦å¯†é‘°æ¨é€åˆ°å…¬é–‹çš„ GitHub
LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN', '(REMOVED_LINE_TOKEN)')
LINE_CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET', '(REMOVED_LINE_SECRET)')

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# --- 2. æº–å‚™å­—å‹èˆ‡åœ–ç‰‡ç›®éŒ„ ---
static_dir = 'static_images'
if not os.path.exists(static_dir):
    os.makedirs(static_dir)

font_file = 'TaipeiSansTCBeta-Regular.ttf'
# å¦‚æœæœ¬åœ°æ²’æœ‰å­—å‹æª”ï¼Œå˜—è©¦ä¸‹è¼‰ (é˜²å‘†æ©Ÿåˆ¶)
if not os.path.exists(font_file):
    print("æ‰¾ä¸åˆ°å­—å‹æª”ï¼Œæ­£åœ¨ä¸‹è¼‰...")
    import urllib.request
    url = "https://drive.google.com/uc?id=1eGAsTN1HBpJAkeVM57_C7ccp7hbgSz3_&export=download"
    urllib.request.urlretrieve(url, font_file)

my_font = FontProperties(fname=font_file)

# --- 3. æ ¸å¿ƒåŠŸèƒ½ A: ç¹ªåœ–å¼•æ“ (æ——è‰¦ç‰ˆ) ---
def create_stock_chart(stock_code):
    try:
        target = stock_code.upper().strip()
        if target.isdigit() and len(target) == 4:
            target += ".TW"
        
        # æŠ“å–è³‡æ–™
        ticker = yf.Ticker(target)
        df = ticker.history(period="1y")
        
        if df.empty: return None, "æ‰¾ä¸åˆ°è³‡æ–™æˆ–ä»£è™ŸéŒ¯èª¤"

        # è¨ˆç®—æŒ‡æ¨™
        df['MA20'] = df['Close'].rolling(window=20).mean()
        df['MA60'] = df['Close'].rolling(window=60).mean()
        std = df['Close'].rolling(window=20).std()
        df['Upper'] = df['MA20'] + (2 * std)
        df['Lower'] = df['MA20'] - (2 * std)
        
        # RSI è¨ˆç®—
        delta = df['Close'].diff()
        gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
        rs = gain / loss
        df['RSI'] = 100 - (100 / (1 + rs))

        # è¨Šè™Ÿ
        df['Signal'] = np.where(df['MA20'] > df['MA60'], 1.0, 0.0)
        df['Position'] = df['Signal'].diff()
        golden = df[df['Position'] == 1.0]
        death = df[df['Position'] == -1.0]

        # é–‹å§‹ç¹ªåœ–
        fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(12, 12), sharex=True, gridspec_kw={'height_ratios': [3, 1, 1]})

        # ä¸»åœ–ï¼šè‚¡åƒ¹ + å¸ƒæ— + å‡ç·š
        ax1.plot(df.index, df['Close'], color='black', alpha=0.6, linewidth=1, label='æ”¶ç›¤åƒ¹')
        ax1.plot(df.index, df['MA20'], color='#FF9900', linestyle='--', label='æœˆç·š')
        ax1.plot(df.index, df['MA60'], color='#0066CC', linewidth=2, label='å­£ç·š')
        ax1.fill_between(df.index, df['Upper'], df['Lower'], color='skyblue', alpha=0.2)
        
        # æ¨™è¨˜è²·è³£é»
        ax1.plot(golden.index, golden['MA20'], '^', color='red', markersize=14, markeredgecolor='black', label='é»ƒé‡‘äº¤å‰')
        ax1.plot(death.index, death['MA20'], 'v', color='green', markersize=14, markeredgecolor='black', label='æ­»äº¡äº¤å‰')
        
        ax1.set_title(f"{target} å°ˆæ¥­åˆ†æåœ–", fontsize=22, fontproperties=my_font, fontweight='bold')
        ax1.legend(loc='upper left', prop=my_font)
        ax1.grid(True, linestyle=':', alpha=0.5)

        # å‰¯åœ–1ï¼šæˆäº¤é‡
        colors = ['red' if c >= o else 'green' for c, o in zip(df['Close'], df['Open'])]
        ax2.bar(df.index, df['Volume'], color=colors, alpha=0.8)
        ax2.set_ylabel("æˆäº¤é‡", fontproperties=my_font)
        ax2.grid(True, linestyle=':', alpha=0.3)

        # å‰¯åœ–2ï¼šRSI
        ax3.plot(df.index, df['RSI'], color='purple', linewidth=1.5, label='RSI')
        ax3.axhline(70, color='red', linestyle='--', alpha=0.5)
        ax3.axhline(30, color='green', linestyle='--', alpha=0.5)
        ax3.set_ylabel("RSI", fontproperties=my_font)
        ax3.grid(True, linestyle=':', alpha=0.3)
        ax3.set_ylim(0, 100)

        fig.autofmt_xdate()
        
        # å­˜æª”
        filename = f"{target.replace('.', '_')}_{int(time.time())}.png"
        filepath = os.path.join(static_dir, filename)
        plt.savefig(filepath, bbox_inches='tight')
        plt.close()
        
        return filename, "Success"
    except Exception as e:
        print(e)
        return None, str(e)

# --- 4. æ ¸å¿ƒåŠŸèƒ½ B: æ™ºèƒ½é¸è‚¡ (å«äº¤æ˜“ç­–ç•¥) ---
def scan_potential_stocks():
    # è§€å¯Ÿåå–®
    watch_list = [
        '2303.TW', '2353.TW', '2324.TW', '2356.TW', '2409.TW', '3481.TW', 
        '2603.TW', '2609.TW', '2615.TW', '2618.TW', '2610.TW', '2606.TW',
        '2884.TW', '2885.TW', '2886.TW', '2890.TW', '2891.TW', '2892.TW', 
        '2002.TW', '2014.TW', '1605.TW', '1904.TW', '1314.TW',
        '3231.TW', '2382.TW', '2376.TW', '2312.TW', '1101.TW'
    ]
    
    recommendations = []
    
    try:
        # æ‰¹æ¬¡ä¸‹è¼‰ä»¥ç¯€çœæ™‚é–“
        data = yf.download(watch_list, period="3mo")
        
        for stock in watch_list:
            try:
                # è™•ç†è³‡æ–™æ ¼å¼ (å–®ä¸€è‚¡ç¥¨ vs å¤šè‚¡ç¥¨)
                if isinstance(data.columns, pd.MultiIndex):
                    closes = data['Close'][stock]
                else:
                    closes = data['Close']
                
                closes = closes.dropna()
                if len(closes) < 60: continue

                current_price = closes.iloc[-1]
                
                # ç¯©é¸æ¢ä»¶ï¼šè‚¡åƒ¹<100, ä¸”ç‚ºå¤šé ­æ’åˆ—
                if current_price > 100: continue
                
                ma20 = closes.rolling(20).mean().iloc[-1]
                ma60 = closes.rolling(60).mean().iloc[-1]
                std = closes.rolling(20).std().iloc[-1]
                
                if ma20 > ma60 and current_price > ma20:
                    bias = (current_price - ma20) / ma20 * 100
                    
                    if bias < 10: # ä¹–é›¢ç‡å°æ–¼ 10%
                        # è¨ˆç®—ç­–ç•¥
                        stop_loss = ma20 * 0.99
                        upper_band = ma20 + (2 * std)
                        target_price = max(upper_band, current_price * 1.05)
                        stock_name = stock.replace('.TW','')
                        
                        info = (
                            f"ğŸ“Œ {stock_name}\n"
                            f"ğŸ’° ç¾åƒ¹: {current_price:.1f}\n"
                            f"ğŸ¯ ç›®æ¨™: {target_price:.1f}\n"
                            f"ğŸ›‘ åœæ: {stop_loss:.1f}"
                        )
                        recommendations.append(info)
            except:
                continue
    except Exception as e:
        return [f"æƒæç™¼ç”ŸéŒ¯èª¤: {str(e)}"]

    return recommendations[:6]

# --- 5. Flask è·¯ç”±è¨­å®š ---

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

@app.route("/")
def home():
    return "Hello, Stock Bot is Running!"

@app.route('/images/<filename>')
def serve_image(filename):
    return send_from_directory(static_dir, filename)

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_msg = event.message.text.strip()
    
    if user_msg == "æ¨è–¦" or user_msg == "é¸è‚¡":
        results = scan_potential_stocks()
        if results:
            reply_text = "ğŸ“Š ã€ç™¾å…ƒæ½›åŠ›è‚¡äº¤æ˜“è¨ˆç•«ã€‘\n(ç´”å±¬æ¼”ç®—æ³•åˆ†æï¼ŒéæŠ•è³‡å»ºè­°)\n====================\n"
            reply_text += "\n\n".join(results)
            reply_text += "\n====================\nğŸ’¡ å»ºè­°ç­–ç•¥ï¼š\næ¥è¿‘æœˆç·šè²·é€²ï¼Œç ´åœæè³£å‡ºï¼Œ\nåˆ°ç›®æ¨™åƒ¹åˆ†æ‰¹ç²åˆ©ã€‚"
        else:
            reply_text = "ç›®å‰å¸‚å ´éœ‡ç›ªï¼Œç„¡ç¬¦åˆé«˜å‹ç‡æ¢ä»¶çš„å€‹è‚¡ï¼Œå»ºè­°è§€æœ›ã€‚"
        
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
        
    else:
        # ç”¢ç”Ÿåœ–ç‰‡ç¶²å€ (ä½¿ç”¨ Render çš„ URL)
        # request.host_url æœƒè‡ªå‹•æŠ“å–ç•¶å‰çš„ç¶²å€ (ä¾‹å¦‚ https://xxx.onrender.com/)
        img_filename, err_msg = create_stock_chart(user_msg)
        if img_filename:
            img_url = request.host_url + 'images/' + img_filename
            line_bot_api.reply_message(
                event.reply_token,
                ImageSendMessage(original_content_url=img_url, preview_image_url=img_url)
            )
        else:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=f"è«‹è¼¸å…¥ä»£è™ŸæŸ¥è©¢ï¼Œæˆ–è¼¸å…¥ã€Œæ¨è–¦ã€ç²å–äº¤æ˜“ç­–ç•¥ã€‚\n(éŒ¯èª¤: {err_msg})")
            )

if __name__ == "__main__":
    app.run()